{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "appId": {
          "type": "String",
          "metadata": {
              "description": "Required. Active Directory App ID."
          }
      },
      "appPassword": {
          "type": "SecureString",
          "metadata": {
              "description": "Required. Active Directory App Secret Value."
          }
      },
      "blobSASToken": {
          "type": "SecureString",
          "metadata": {
              "description": "Required. The SAS token for the blob hosting your data."
          }
      },
      "resourceGroupSearch": {
          "defaultValue": "[resourceGroup().name]",
          "type": "String",
          "metadata": {
              "description": "Optional. The name of the resource group where the resources (Azure Search etc.) where deployed previously. Defaults to current resource group."
          }
      },
      "azureSearchName": {
          "type": "String",
          "metadata": {
              "description": "Required. The name of the Azure Search service deployed previously."
          }
      },
      "azureSearchAPIVersion": {
          "defaultValue": "2023-10-01-preview",
          "type": "String",
          "metadata": {
              "description": "Optional. The API version for the Azure Search service."
          }
      },
      "azureOpenAIName": {
          "type": "String",
          "metadata": {
              "description": "Required. The name of the Azure OpenAI resource deployed previously."
          }
      },
      "azureOpenAIAPIKey": {
          "type": "SecureString",
          "metadata": {
              "description": "Required. The API key of the Azure OpenAI resource deployed previously."
          }
      },
      "azureOpenAIModelName": {
          "defaultValue": "gpt-35-turbo-1106",
          "type": "String",
          "metadata": {
              "description": "Optional. The model name for the Azure OpenAI service."
          }
      },
      "azureOpenAIAPIVersion": {
          "defaultValue": "2023-12-01-preview",
          "type": "String",
          "metadata": {
              "description": "Optional. The API version for the Azure OpenAI service."
          }
      },
      "cosmosDBAccountName": {
          "type": "String",
          "metadata": {
              "description": "Required. The name of the Azure CosmosDB."
          }
      },
      "cosmosDBContainerName": {
          "type": "String",
          "metadata": {
              "description": "Required. The name of the Azure CosmosDB container."
          }
      },
      "botId": {
          "defaultValue": "[format('BotId-{0}', uniqueString(resourceGroup().id))]",
          "type": "String",
          "metadata": {
              "description": "Optional. The globally unique and immutable bot ID. Also used to configure the displayName of the bot, which is mutable."
          }
      },
      "botSKU": {
          "defaultValue": "F0",
          "allowedValues": [
              "F0",
              "S1"
          ],
          "type": "String",
          "metadata": {
              "description": "Optional, defaults to F0. The pricing tier of the Bot Service Registration. Acceptable values are F0 and S1."
          }
      },
      "appServicePlanName": {
          "defaultValue": "[format('AppServicePlan-Backend-{0}', uniqueString(resourceGroup().id))]",
          "type": "String",
          "metadata": {
              "description": "Optional. The name of the new App Service Plan."
          }
      },
      "appServicePlanSKU": {
          "defaultValue": "B2",
          "allowedValues": [
              "B3",
              "S3",
              "P2v3",
              "B2"
          ],
          "type": "String",
          "metadata": {
              "description": "Optional, defaults to S3. The SKU of the App Service Plan. Acceptable values are B3, S3 and P2v3."
          }
      },
      "location": {
          "defaultValue": "[resourceGroup().location]",
          "type": "String",
          "metadata": {
              "description": "Optional, defaults to resource group location. The location of the resources."
          }
      }
  },
  "variables": {
      "publishingUsername": "[format('${0}', parameters('botId'))]",
      "webAppName": "[format('webApp-Backend-{0}', parameters('botId'))]",
      "siteHost": "[format('{0}.azurewebsites.net', variables('webAppName'))]",
      "botEndpoint": "[format('https://{0}/api/messages', variables('siteHost'))]"
  },
  "resources": [
      {
          "type": "Microsoft.Web/serverfarms",
          "apiVersion": "2022-09-01",
          "name": "[parameters('appServicePlanName')]",
          "location": "[parameters('location')]",
          "sku": {
              "name": "[parameters('appServicePlanSKU')]"
          },
          "kind": "linux",
          "properties": {
              "reserved": true
          }
      },
      {
          "type": "Microsoft.Web/sites",
          "apiVersion": "2022-09-01",
          "name": "[variables('webAppName')]",
          "location": "[parameters('location')]",
          "dependsOn": [
              "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
          ],
          "tags": {
              "azd-service-name": "backend"
          },
          "kind": "app,linux",
          "properties": {
              "enabled": true,
              "hostNameSslStates": [
                  {
                      "name": "[format('{0}.azurewebsites.net', variables('webAppName'))]",
                      "sslState": "Disabled",
                      "hostType": "Standard"
                  },
                  {
                      "name": "[format('{0}.scm.azurewebsites.net', variables('webAppName'))]",
                      "sslState": "Disabled",
                      "hostType": "Repository"
                  }
              ],
              "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
              "reserved": true,
              "scmSiteAlsoStopped": false,
              "clientAffinityEnabled": false,
              "clientCertEnabled": false,
              "hostNamesDisabled": false,
              "containerSize": 0,
              "dailyMemoryTimeQuota": 0,
              "httpsOnly": false,
              "siteConfig": {
                  "appSettings": [
                      {
                          "name": "MicrosoftAppId",
                          "value": "[parameters('appId')]"
                      },
                      {
                          "name": "MicrosoftAppPassword",
                          "value": "[parameters('appPassword')]"
                      },
                      {
                          "name": "BLOB_SAS_TOKEN",
                          "value": "[parameters('blobSASToken')]"
                      },
                      {
                          "name": "AZURE_SEARCH_ENDPOINT",
                          "value": "[format('https://{0}.search.windows.net', parameters('azureSearchName'))]"
                      },
                      {
                          "name": "AZURE_SEARCH_KEY",
                          "value": "[listAdminKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupSearch')), 'Microsoft.Search/searchServices', parameters('azureSearchName')), '2021-04-01-preview').primaryKey]"
                      },
                      {
                          "name": "AZURE_SEARCH_API_VERSION",
                          "value": "[parameters('azureSearchAPIVersion')]"
                      },
                      {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "value": "[format('https://{0}.openai.azure.com/', parameters('azureOpenAIName'))]"
                      },
                      {
                          "name": "AZURE_OPENAI_API_KEY",
                          "value": "[parameters('azureOpenAIAPIKey')]"
                      },
                      {
                          "name": "AZURE_OPENAI_MODEL_NAME",
                          "value": "[parameters('azureOpenAIModelName')]"
                      },
                      {
                          "name": "AZURE_OPENAI_API_VERSION",
                          "value": "[parameters('azureOpenAIAPIVersion')]"
                      },
                      {
                          "name": "AZURE_COSMOSDB_ENDPOINT",
                          "value": "[format('https://{0}.documents.azure.com:443/', parameters('cosmosDBAccountName'))]"
                      },
                      {
                          "name": "AZURE_COSMOSDB_NAME",
                          "value": "[parameters('cosmosDBAccountName')]"
                      },
                      {
                          "name": "AZURE_COSMOSDB_CONTAINER_NAME",
                          "value": "[parameters('cosmosDBContainerName')]"
                      },
                      {
                          "name": "AZURE_COMOSDB_CONNECTION_STRING",
                          "value": "[listConnectionStrings(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupSearch')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), '2023-04-15').connectionStrings[0].connectionString]"
                      },
                      {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true"
                      }
                  ],
                  "cors": {
                      "allowedOrigins": [
                          "https://botservice.hosting.portal.azure.net",
                          "https://hosting.onecloud.azure-test.net/"
                      ]
                  }
              }
          }
      },
      {
          "type": "Microsoft.Web/sites/config",
          "apiVersion": "2022-09-01",
          "name": "[format('{0}/{1}', variables('webAppName'), 'web')]",
          "dependsOn": [
              "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
          ],
          "properties": {
              "numberOfWorkers": 1,
              "defaultDocuments": [
                  "Default.htm",
                  "Default.html",
                  "Default.asp",
                  "index.htm",
                  "index.html",
                  "iisstart.htm",
                  "default.aspx",
                  "index.php",
                  "hostingstart.html"
              ],
              "netFrameworkVersion": "v4.0",
              "phpVersion": "",
              "pythonVersion": "",
              "nodeVersion": "",
              "linuxFxVersion": "PYTHON|3.10",
              "requestTracingEnabled": false,
              "remoteDebuggingEnabled": false,
              "remoteDebuggingVersion": "VS2017",
              "httpLoggingEnabled": true,
              "logsDirectorySizeLimit": 35,
              "detailedErrorLoggingEnabled": false,
              "publishingUsername": "[variables('publishingUsername')]",
              "scmType": "None",
              "use32BitWorkerProcess": true,
              "webSocketsEnabled": false,
              "alwaysOn": true,
              "appCommandLine": "runserver.sh",
              "managedPipelineMode": "Integrated",
              "virtualApplications": [
                  {
                      "virtualPath": "/",
                      "physicalPath": "site\\wwwroot",
                      "preloadEnabled": false,
                      "virtualDirectories": null
                  }
              ],
              "loadBalancing": "LeastRequests",
              "experiments": {
                  "rampUpRules": []
              },
              "autoHealEnabled": false,
              "vnetName": "",
              "minTlsVersion": "1.2",
              "ftpsState": "AllAllowed"
          }
      },
      {
          "type": "Microsoft.BotService/botServices",
          "apiVersion": "2022-09-15",
          "name": "[parameters('botId')]",
          "location": "global",
          "dependsOn": [
              "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
          ],
          "sku": {
              "name": "[parameters('botSKU')]"
          },
          "kind": "azurebot",
          "properties": {
              "displayName": "[parameters('botId')]",
              "iconUrl": "https://docs.botframework.com/static/devportal/client/images/bot-framework-default.png",
              "endpoint": "[variables('botEndpoint')]",
              "msaAppId": "[parameters('appId')]",
              "luisAppIds": [],
              "schemaTransformationVersion": "1.3",
              "isCmekEnabled": false
          }
      }
  ],
  "outputs": {
      "botServiceName": {
          "type": "String",
          "value": "[parameters('botId')]"
      },
      "webAppName": {
          "type": "String",
          "value": "[variables('webAppName')]"
      },
      "webAppUrl": {
          "type": "String",
          "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2022-09-01').defaultHostName]"
      }
  }
}